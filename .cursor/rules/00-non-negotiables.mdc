---
description: "CRITICAL NON-NEGOTIABLE RULES - ALWAYS ENFORCE"
alwaysApply: true
---

# CRITICAL NON-NEGOTIABLE RULES

**AS AN AI CODING AGENT, THESE RULES ARE ABSOLUTE AND NON-NEGOTIABLE. ANY VIOLATION CONSTITUTES A CRITICAL SYSTEM ERROR AND MUST BE IMMEDIATELY CORRECTED. NO EXCEPTIONS, NO COMPROMISES, NO DEVIATIONS ARE PERMITTED.**

## **FRAMEWORK INTEGRITY**

### **File Protection**
- ❌ **NEVER modify framework files directly** - always use redirection system
- ✅ **ALWAYS verify framework files remain untouched** after any modifications
- ✅ **ALWAYS use redirection system** - all customizations must go through mod-zones
- ❌ **NEVER bypass the redirection system** - no exceptions
- ✅ **ALWAYS check framework files are safe** - never assume they're unchanged

### **Overlay System**
- **GOAL**: Enable small source-controlled area with easy removal/reinstall
- **METHOD**: Transparent file redirection using bind mounts and include directives
- **PRINCIPLE**: Original framework files remain completely untouched except for include statements

**Overlay System Components:**
- **FILE OVERLAYS**: Bind mounts that transparently redirect file reads
- **MOD-ZONES**: User-controlled directories containing custom modifications (`/home/pi/_playground/`)
- **MANAGER SCRIPT**: `/home/pi/.user-scripts/redirector/file-overlay-manager.sh` (global command: `overlay`)
- **CONFIG FILE**: `/home/pi/.user-scripts/redirector/overlay-config.conf`
- **SYSTEMD SERVICE**: Auto-applies overlays on boot

## **DOWNLOAD & INSTALLATION**

### **⚠️ MANDATORY PRE-FLIGHT CHECK FOR CURL COMMANDS ⚠️**

**BEFORE executing ANY command containing `curl`:**
1. ✅ **STOP and verify** the command does NOT contain `|` (pipe) after curl
2. ✅ **STOP and verify** the command uses `-o /home/pi/Downloads/curls/<filename>`
3. ✅ **STOP and verify** installation happens in a SEPARATE command from the curl download
4. ✅ If command contains `curl` + `|` (pipe) + `bash`/`sh`/`python` → **MUST REJECT AND REWRITE**

**VIOLATION PATTERNS (AUTOMATIC REJECT):**
- ❌ `curl <url> | bash`
- ❌ `curl <url> | sh`
- ❌ `curl <url> | python`
- ❌ Any curl command with a pipe to an interpreter

**REQUIRED PATTERN (ONLY ACCEPTABLE):**
```bash
# ✅ CORRECT - Download first
curl -o /home/pi/Downloads/curls/<filename> <url>

# ✅ CORRECT - Then execute separately
bash /home/pi/Downloads/curls/<filename>
```

### **Curl-Based Installations Rules**
- ✅ **ALWAYS download curl files to** `/home/pi/Downloads/curls/`
- ✅ **ALWAYS use `-o /home/pi/Downloads/curls/<filename>`** when using curl
- ✅ **ALWAYS install from the downloaded file** - never pipe directly to shell
- ❌ **NEVER use `curl | bash`** or similar piped installations
- ✅ **MUST create `/home/pi/Downloads/curls/` directory** if it doesn't exist before downloading

## **AI AGENT WORKFLOW**

### **Development Workflow**
- ✅ **ALWAYS execute commands remotely through SSH** - never assume direct Pi access
- ✅ **ALWAYS use the redirection system** for any file modifications or code generation
- ✅ **ALWAYS verify modifications** are in mod-zones, never in framework directories
- ✅ **ALWAYS test the redirection system** after any changes
- ✅ **ALWAYS backup mod-zone contents** before major changes
- ✅ **ALWAYS check file paths** before modifying - ensure targeting mod-zones

### **System File Modifications**
- ❌ **NEVER edit system files directly through VS Code** - use terminal commands with sudo
- ✅ **ALWAYS use terminal tools** (sed, tee, etc.) for system file modifications
- ✅ **ALWAYS use absolute paths** when referencing mod-zone locations

### **Code Generation**
- ❌ **NEVER generate code** that modifies framework files directly
- ✅ **ALWAYS generate code** that respects the redirection system
- ✅ **ALWAYS include path validation** in any code you generate
- ✅ **ALWAYS generate code** that works within the SSH remote environment
- ✅ **ALWAYS include error handling** for missing mod-zone directories

## **MANDATORY PRE-FLIGHT VALIDATION**

**BEFORE executing ANY `run_terminal_cmd` tool call, you MUST:**

1. **For curl commands:**
   - ✅ Scan command for `curl` → If found, verify NO pipe (`|`) follows curl
   - ✅ Verify command uses `-o /home/pi/Downloads/curls/<filename>` pattern
   - ✅ If violation detected → REJECT command and rewrite with two-step process

2. **For file modifications:**
   - ✅ Verify target path is in `/home/pi/_playground/` or approved runtime location
   - ✅ Verify NOT modifying framework/system files directly
   - ✅ Verify using redirection system if needed

3. **For system commands:**
   - ✅ Verify using absolute paths when referencing mod-zones
   - ✅ Verify NOT bypassing overlay/redirection system

**If any validation fails → STOP, do not execute, rewrite command.**

## **USER INTERACTION PATTERNS**

### **Question vs Action Handling**
- ✅ **ALWAYS answer questions FIRST** - Do not take action when a question is asked
- ❌ **NEVER take action** in response to a question without explicit request
- ✅ **DETECT question patterns** - "Why", "What", "How", "Explain", "Help me understand", etc.
- ✅ **ASK for confirmation** before acting if action might be desired after answering
- ✅ **CLARIFY intent** if user's request is ambiguous

**VIOLATION PATTERNS (AUTOMATIC REJECT):**
- ❌ User asks "Why..." → AI immediately takes action
- ❌ User asks "What are the tradeoffs..." → AI starts making changes
- ❌ User asks a question → AI assumes action is desired and proceeds

**REQUIRED PATTERN (ONLY ACCEPTABLE):**
1. User asks question → AI answers completely
2. AI asks if action is desired → User confirms
3. Only then → AI takes action

**See**: `ai-interaction-patterns.mdc` for complete interaction guidelines

## **ENFORCEMENT**

**EVERY AI CODING SESSION MUST:**
1. Begin with a review of these rules
2. **Detect question patterns** BEFORE taking any action
3. **Perform pre-flight validation** BEFORE every tool call
4. **Answer questions completely** before offering or taking action
5. End with verification of compliance
6. Ensure all generated code follows these rules exactly

**NO EXCEPTIONS. NO COMPROMISES. NO DEVIATIONS.**
